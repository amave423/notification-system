# Email Notification Service

## Описание проекта

Email Notification Service — это микросервис, отвечающий за отправку уведомлений через email-канал в рамках распределенной системы уведомлений. Микросервис является независимым и масштабируемым компонентом, предназначенным для обработки email-уведомлений в асинхронном режиме.

### Основные функции
- Получение уведомлений из очереди сообщений
- Отправка email через SMTP
- Сохранение статуса уведомлений в базе данных
- Повторная отправка при неудачах
- Сбор метрик и логирование

## Архитектура

Микросервис построен по принципам чистой архитектуры с разделением на слои:
- **Domain** — бизнес-логика и контракты
- **Api** — модели для внешнего взаимодействия
- **WebApi** — веб-приложение с API и обработчиками сообщений
- **Tests** — модульные и интеграционные тесты

Для асинхронной обработки используется RabbitMQ: микросервис подписывается на очередь `email-queue` и обрабатывает сообщения из exchange `notifications-exchange` с routing key `email`.

## Технологии

- **Язык и фреймворк**: C# .NET 10
- **База данных**: PostgreSQL для хранения уведомлений и их статусов
- **Очереди сообщений**: RabbitMQ с MassTransit для асинхронной обработки
- **Отправка email**: MailKit для SMTP-клиента с политикой повторных попыток (Polly)
- **Логирование**: Serilog с выводом в консоль и Elasticsearch
- **Метрики**: Prometheus для мониторинга (счетчики отправленных/неудачных email, latency)
- **Тестирование**: NUnit для unit-тестов, MassTransit.Testing для интеграционных тестов
- **Контейнеризация**: Docker Compose для локальной разработки (PostgreSQL, RabbitMQ, Elasticsearch, MailHog)

## Запуск проекта

### Требования
- .NET 10 SDK
- Docker и Docker Compose

### Локальный запуск
1. Клонируйте репозиторий
2. Перейдите в директорию `WebApi`
3. Запустите инфраструктуру: `docker-compose up -d`
4. Запустите приложение: `dotnet run`

Приложение будет доступно на порту, указанном в `launchSettings.json` (обычно 5000/5001).

### Конфигурация
Настройки подключений (RabbitMQ, PostgreSQL, SMTP, Elasticsearch) задаются в `appsettings.json` и `appsettings.Development.json`.

## Тестирование

Проект включает модульные и интеграционные тесты:
- **NotificationRepositoryTests** — тестирование репозитория уведомлений
- **EmailNotificationConsumerTests** — тестирование consumer'а с использованием MassTransit.Testing
- **IntegrationTests** — комплексные интеграционные тесты

Для запуска тестов: `dotnet test` в корне проекта.

## Структура проекта

```
EmailNotificationService/
├── Api/                    # Модели для API
├── Domain/                 # Бизнес-логика и контракты
├── Tests/                  # Тесты
└── WebApi/                 # Веб-приложение
    ├── Consumers/          # Обработчики сообщений RabbitMQ
    ├── Data/               # Контекст БД и репозиторий
    ├── Services/           # Сервисы (EmailSender, PrometheusExporter)
    └── appsettings.json    # Конфигурация
```